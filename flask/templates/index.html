<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <link rel="shortcut icon" href="{{ fav_icon }}" />
    <title>CutCat</title>
  </head>
  <body>
    <div id="root"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <script type="text/babel">
      function Main({ sessionId, socket }) {
        const [msg, setMsg] = React.useState([]);

        const handler = (message) => {
          console.log(message.message);
          setMsg([...msg, message.message]);
        };

        React.useEffect(() => {
          socket.on(sessionId, handler);
          return () => {
            socket.off(sessionId, handler);
          };
        }, []);

        return (
          <div>
            <h1> welcome </h1>
            {msg.map((m) => (
              <p>{m}</p>
            ))}
          </div>
        );
      }

      function MainContainer() {
        const [sessionId, setSessionId] = React.useState("");
        const socket = io.connect(
          "http://" + document.domain + ":" + location.port
        );

        React.useEffect(() => {
          console.group(
            "%c CutCat",
            "font-weight: bold; font-size: 50px;color: red; text-shadow: 3px 3px 0 rgb(217,31,38) , 6px 6px 0 rgb(226,91,14) , 9px 9px 0 rgb(245,221,8) , 12px 12px 0 rgb(5,148,68) , 15px 15px 0 rgb(2,135,206) , 18px 18px 0 rgb(4,77,145) , 21px 21px 0 rgb(42,21,113)"
          );
          console.log(
            "Created by : " + "%cAnis Snoussi",
            "background-color: rgb(217,31,38) ; color: #ffffff ; font-weight: bold ; padding: 4px ;"
          );
          console.log(
            "Contact email : " + "%csnoussi.anis@insat.u-carthage.tn",
            "background-color: rgb(217,31,38) ; color: #ffffff ; font-weight: bold ; padding: 4px ;"
          );
          console.log(
            "Open Source : " + "%chttps://github.com/ansnoussi/CutCat",
            "background-color: rgb(217,31,38) ; color: #ffffff ; font-weight: bold ; padding: 4px ;"
          );
          console.log(
            "License : " + "%cI don't even know...",
            "background-color: rgb(217,31,38) ; color: #ffffff ; font-weight: bold ; padding: 4px ;"
          );

          console.groupEnd();
        }, []);

        const joinTopic = () => {
          fetch("http://" + document.domain + ":" + location.port + "/join", {
            method: "POST",
          })
            .then(() => {
              return fetch(
                "http://" +
                  document.domain +
                  ":" +
                  location.port +
                  "/get_cur_session",
                { method: "GET" }
              );
            })

            .then((rez) => {
              return rez.text();
            })
            .then((session_id_as_topic_name) => {
              setSessionId(session_id_as_topic_name);
            })
            .catch((e) => {
              console.log(e);
            });
        };

        const postInTopic = () => {
          console.log("will post in topic");
          fetch(
            "http://" + document.domain + ":" + location.port + "/post_topic",
            {
              method: "POST",
            }
          )
            .then(() => {
              console.log("posted");
            })
            .catch((e) => {
              console.log(e);
            });
        };

        return (
          <div>
            {sessionId !== "" && <Main sessionId={sessionId} socket={socket} />}
            <button onClick={joinTopic}>JOIN</button>
            <button onClick={postInTopic}>TEST</button>
          </div>
        );
      }

      ReactDOM.render(<MainContainer />, document.getElementById("root"));
    </script>
  </body>
</html>
